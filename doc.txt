5　详细设计
本章主要针对系统设计的详细过程，从管理员和用户的登录注册，普通用户功能的详细设计，商家用户的功能设计，管理员功能的详细设计，难点及解决方案等各方面进行阐述。
5.1.1 用户登录功能
用户访问平台时，首先通过前端调用 /captchaImage 接口获取验证码图片。用户在登录页面输入用户名、密码及验证码后，前端将数据提交至后端的 /login 接口。后端通过 UsernamePasswordToken 封装用户凭证，并调用 UserDetailsServiceImpl 从数据库中查询用户信息。系统依次验证用户是否存在、密码是否匹配、账号是否被锁定或禁用，同时校验验证码的正确性。若所有验证通过，TokenService 生成包含用户身份信息的 JWT Token，返回给前端；前端将 Token 存储于 localStorage 中，后续请求通过请求拦截器自动携带该 Token 以维持登录状态，并跳转至系统首页。若任意验证失败，如用户名不存在、密码错误或验证码失效，后端返回具体错误信息，前端保持登录页面并展示错误提示，供用户重新尝试。
5.1.2 用户注册功能
用户通过访问 /register 接口进入注册页面。用户需要填写用户名、密码、确认密码、角色类型及验证码等信息。前端将数据提交至后端的 /register 接口，后端首先校验用户名唯一性，若已存在则返回"用户名已被占用"；随后检查密码复杂度、两次密码输入是否一致及验证码有效性。若全部通过，系统使用 BCryptPasswordEncoder 对密码加密存储至数据库，并为用户分配默认角色，同时记录注册时间、IP等信息。注册成功后，前端显示"注册成功"提示，并自动跳转至登录页面；若任一校验失败，后端返回具体错误信息，前端保持注册页面并高亮提示问题字段，引导用户修正后重新提交。
5.1.3 苹果商品管理功能
管理员访问苹果商品管理模块时，前端通过调用 /system/apples/list 接口加载所有苹果列表。管理员可以通过 /system/apples/add 接口添加新苹果，通过 /system/apples/edit 接口修改苹果信息，通过 /system/apples/{productType} 接口查看苹果详情，通过 /system/apples/remove 接口删除苹果。系统支持苹果的上架和下架操作，管理员可以通过接口将苹果标记为不同状态。每种苹果都包含基本信息，如商品名称、库存、描述、图片等。系统会自动记录商品的创建时间、修改时间、操作人等信息，方便追踪商品变更历史。
5.1.4 苹果定价功能
系统根据苹果的品质等级（qualityLevel）进行分级，通常分为特级、一级、二级、三级等。每种苹果类型都有基础价格，例如红富士特级苹果基础价格为100元/斤。根据品质等级，系统会自动计算最终价格：
特级：基础价格 × 1.5
一级：基础价格 × 1.2
二级：基础价格 × 1.0
三级：基础价格 × 0.8
管理员在添加或修改苹果信息时，需要设置苹果的品质等级，系统会自动根据预设的定价规则计算最终价格。价格计算完成后，系统会更新商品信息，并在前端展示计算后的价格。管理员可以通过 /system/apples/edit 接口修改苹果的品质等级，系统会自动重新计算价格。
5.1.5 苹果联合查询功能
系统支持多种苹果类型的联合查询，包括红富士苹果（/system/redFuji/list）、红星苹果（/system/hongxing/list）、国光苹果（/system/guoguang/list）、金冠苹果（/system/jinguan/list）和青苹果（/system/green/list）。用户可以通过 /system/apples/list 接口获取所有苹果列表，系统支持按以下条件进行筛选：
按苹果类型筛选：可以指定查询特定类型的苹果
按品质等级筛选：可以筛选出特定品质等级的苹果
按价格区间筛选：可以设置价格范围进行筛选
按库存状态筛选：可以筛选出有货或无货的苹果
按上架状态筛选：可以筛选出已上架或已下架的苹果
系统会根据筛选条件返回符合条件的苹果列表，并在前端展示。用户可以通过 /system/apples/{productType} 接口查看单个苹果的详细信息，包括价格、库存、描述、图片等。
5.1.6 购物车管理功能
用户浏览苹果商品时，可以通过 /system/apples/{productType} 接口查看单个苹果的详细信息。当用户选择将苹果加入购物车时，前端会检查库存是否充足，然后调用 /system/cart/add 接口将商品添加到购物车。购物车信息包括用户ID、商品ID、商品数量、商品单价等。用户可以通过 /system/cart/list 接口查看购物车列表，通过 /system/cart/edit 接口修改商品数量，通过 /system/cart/remove 接口删除购物车商品。系统会自动计算购物车总价，并在用户确认订单时进行库存检查。如果库存不足，系统会提示用户调整数量或选择其他商品。购物车数据会实时同步到后端，确保用户在不同设备上访问时数据保持一致。用户可以通过 /system/cart/clear 接口清空购物车，通过 /system/cart/update/quantity 接口批量更新商品数量。
5.1.7 订单管理功能
用户确认购物车商品后，系统会通过 /system/order/add 接口创建订单并更新相关商品的库存。订单信息包括订单ID、用户ID、商品列表、总价、订单状态、创建时间等。订单状态包括：待付款、待发货、已发货、已完成、已取消等。用户可以通过 /system/order/list 接口查看所有订单，通过 /system/order/{orderId} 接口查看订单详情。管理员可以通过 /system/order/list 接口查看所有订单，通过 /system/order/status/update 接口更新订单状态，如发货、取消订单等。系统会自动记录订单状态变更历史，方便追踪订单处理过程。订单支付通过 /system/order/pay 接口处理，支付成功后系统会自动更新订单状态为待发货。用户可以通过 /system/order/cancel 接口取消未付款的订单，通过 /system/order/refund 接口申请退款。系统支持订单导出功能，管理员可以通过 /system/order/export 接口导出订单数据。
5.1.8 评论管理功能
用户购买苹果后，可以在商品详情页面发表评论。评论内容通过 /system/comment/add 接口保存到数据库，包括用户ID、商品ID、评分、评论内容、评论时间、订单ID等信息。评论评分采用五星制，用户可以对商品的外观、口感、新鲜度等方面进行评分。管理员可以通过 /system/comment/list 接口查看所有评论，通过 /system/comment/remove 接口删除违规评论。系统支持通过 /system/comment/product/{productId} 接口按商品ID查询相关评论，并在商品详情页面展示评论列表，帮助其他用户了解商品质量。评论支持图片上传功能，用户可以通过 /system/comment/upload 接口上传评论图片。系统会自动对评论内容进行敏感词过滤，违规评论会被标记为待审核状态。管理员可以通过 /system/comment/audit 接口审核评论，通过 /system/comment/reply 接口回复用户评论。评论数据会用于计算商品的综合评分，系统通过 /system/comment/score/{productId} 接口获取商品的评分统计信息。
